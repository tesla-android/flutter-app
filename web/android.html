<html>

<head>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #canvas {
      width: 100%;
      height: 100%;
      position: absolute;
      display: none;
      z-index: 1;
    }

    #image {
      width: 100%;
      display: none;
    }

    #stats {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 5px;
      border-radius: 5px;
    }
  </style>
  <script src="pcmplayer.js"></script>
  <script src="reconnecting-websocket.js"></script>
</head>

<body>
<span id="stats"></span>
<img id="image" />
<canvas id="canvas"></canvas>
<script>
    var audioPlayer;

    var audioWebsocketUrl;
    var displayWebsocketUrl;
    var gpsWebsocketUrl;
    var touchScreenWebsocketUrl;

    var audioSocket;
    var displaySocket;
    var gpsSocket;
    var touchScreenSocket;

    var isAudioEnabled;
    var audioVolume;

    var displayRenderer;
    var displayBinaryType;
    var displayWidth;
    var displayHeight;
    var displayRendererAdded = false;

    window.parent.addEventListener(
      "message",
      (event) => {
        if (event.data.includes("touchScreenCommand")) {
          if (typeof touchScreenSocket != "undefined") {
            var command = event.data.replace('touchScreenCommand:', '');
            touchScreenSocket.send(command);
          }
          return;
        }
        const config = JSON.parse(event.data);
        audioWebsocketUrl = config.audioWebsocketUrl;
        displayWebsocketUrl = config.displayWebsocketUrl;
        gpsWebsocketUrl = config.gpsWebsocketUrl;
        touchScreenWebsocketUrl = config.touchScreenWebsocketUrl;
        isAudioEnabled = config.isAudioEnabled;
        audioVolume = config.audioVolume;
        displayRenderer = config.displayRenderer;
        displayBinaryType = config.displayBinaryType;
        displayWidth = config.displayWidth;
        displayHeight = config.displayHeight;

        if (document.readyState === "complete") {
          if (!audioSocket) createAudioSocket(audioWebsocketUrl);
          if (!displaySocket) createDisplaySocket(displayWebsocketUrl, displayRenderer, displayBinaryType);
          if (!gpsSocket) createGpsSocket(gpsWebsocketUrl);
          if (!touchScreenSocket) createTouchScreenSocket(touchScreenWebsocketUrl);
        } else {
          document.addEventListener("DOMContentLoaded", function () {
            if (!audioSocket) createAudioSocket(audioWebsocketUrl);
            if (!displaySocket) createDisplaySocket(displayWebsocketUrl, displayRenderer, displayBinaryType);
            if (!gpsSocket) createGpsSocket(gpsWebsocketUrl);
            if (!touchScreenSocket) createTouchScreenSocket(touchScreenWebsocketUrl);
          });
        }
      },
      false
    );

    function createAudioSocket(url) {
      if (!isAudioEnabled) {
        return;
      }
      audioSocket = new ReconnectingWebSocket(url, null, { binaryType: 'arraybuffer' });

      audioSocket.onopen = () => {
        console.log("Audio: Websocket connection established")
      };

      audioSocket.onclose = () => {
        console.log("Audio: Websocket connection closed")
      };

      audioSocket.onerror = error => {
        console.log("Audio: " + error)
      };

      audioSocket.onmessage = (event) => {
        if (typeof audioPlayer != "undefined" && event.data instanceof ArrayBuffer) {
          audioPlayer.feed(event.data);
        }
      };
    }

    function createDisplaySocket(url, renderer, binaryType) {
      if (!displayRendererAdded) {
        var rendererScript = document.createElement('script');
        rendererScript.src = renderer + '.js';
        document.head.appendChild(rendererScript);
        displayRendererAdded = true;
      }

      displaySocket = new ReconnectingWebSocket(url, null, { binaryType: binaryType });

      displaySocket.onopen = () => {
        console.log("Display: Websocket connection established");
      };

      displaySocket.onclose = () => {
        console.log("Display: Websocket connection closed")
      };

      displaySocket.onerror = error => {
        console.log("Display: " + error)
      };

      displaySocket.onmessage = (event) => {
        drawDisplayFrame(event.data);
      };
    }

    function createGpsSocket(url) {
      gpsSocket = new ReconnectingWebSocket(url);

      gpsSocket.onopen = () => {
        console.log("GPS: Websocket connection established")
      };

      gpsSocket.onclose = () => {
        console.log("GPS: Websocket connection closed")
      };

      gpsSocket.onerror = error => {
        console.log("GPS: " + error);
      };

      gpsSocket.onmessage = (event) => {
        console.log("GPS: " + message);
      };
    }

    function createTouchScreenSocket(url) {
      touchScreenSocket = new ReconnectingWebSocket(url);

      touchScreenSocket.onopen = () => {
        console.log("Touch: Websocket connection established")
      };

      touchScreenSocket.onclose = () => {
        console.log("Touch: Websocket connection closed")
      };

      touchScreenSocket.onerror = error => {
        console.log("Touch: " + error);
      };

      touchScreenSocket.onmessage = (event) => {
        console.log("Touch: " + message);
      };
    }

    window.parent.addEventListener("click", function (e) {
      if (!audioPlayer && isAudioEnabled) {
        audioPlayer = new PCMPlayer({
          inputCodec: "Float32",
          channels: 2,
          sampleRate: 48000,
          flushTime: 200,
        });
      }
    });
    function feedPlayer(data) {
      if (typeof audioPlayer != "undefined" && isAudioEnabled) {
        audioPlayer.feed(data);
      }
    }
    function setPlayerVolume(volume) {
      if (typeof audioPlayer != "undefined" && isAudioEnabled) {
        audioPlayer.volume(volume);
      }
    }

    let locationData;

    async function updateLocation(maximumAge, timeout) {
      try {
        locationData = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => resolve(toLocationData(position)),
            (error) => reject(error),
            { enableHighAccuracy: true, maximumAge, timeout }
          );
        });
      } catch (error) {
        console.error(error);
      }
    }

    let locationTimer = setInterval(async () => {
      if (!locationData) {
        await updateLocation(2500, 2500);
      }

      if (locationData) {
        gpsSocket.send(locationData);
        locationData = null;
      }
    }, 2500);

    function toLocationData(position) {
      const locationData = {
        latitude: String(position.coords.latitude),
        longitude: String(position.coords.longitude),
      };

      return JSON.stringify(locationData);
    }
  </script>
</body>

</html>